<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì°¨ëŸ‰ íŒŒì† ì´ë¯¸ì§€ ë¶„ì„ ì‹œìŠ¤í…œ</title>
  <!-- Cropper.js ìŠ¤íƒ€ì¼ -->
  <link
    href="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.css"
    rel="stylesheet"
  >
  <style>
    body { font-family: sans-serif; padding: 20px; }
    h2 { margin-bottom: 10px; }
    p { margin-bottom: 20px; }
    img { max-width: 100%; display: block; }
    #preview { max-width: 500px; margin-top: 10px; border: 1px solid #ccc; }
    #controls { margin-top: 10px; }
    #controls button {
      padding: 10px 15px;
      margin-right: 10px;
      font-size: 15px;
      cursor: pointer;
    }
    #controls button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #message { margin-top: 15px; color: #d00; }
  </style>
</head>
<body>
  <h2>ì°¨ëŸ‰ íŒŒì† ì´ë¯¸ì§€ ë¶„ì„ ì‹œìŠ¤í…œ</h2>
  <p>ì—¬ëŸ¬ ì¥ì˜ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ê³ , ë¶„ì„í•  ë¶€ë¶„ë§Œ ìˆœì°¨ì ìœ¼ë¡œ í¬ë¡­í•œ ë’¤ ì „ì†¡í•˜ì„¸ìš”.</p>

  <input type="file" id="imageInput" accept="image/*" multiple><br>
  <img id="preview" style="display:none;">
  <div id="controls" style="display:none;">
    <button id="cropButton" disabled>ğŸ–¼ í˜„ì¬ ì´ë¯¸ì§€ í¬ë¡­</button>
    <button id="nextButton" disabled>â ë‹¤ìŒ ì´ë¯¸ì§€</button>
    <button id="submitButton" disabled>ğŸ“¤ ë¶„ì„ ì œì¶œ</button>
  </div>
  <div id="message"></div>

  <!-- Cropper.js UMD ë²ˆë“¤ -->
  <script src="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.js"></script>
  <script>
  window.addEventListener('DOMContentLoaded', () => {
    const inputEl   = document.getElementById('imageInput');
    const preview   = document.getElementById('preview');
    const controls  = document.getElementById('controls');
    const cropBtn   = document.getElementById('cropButton');
    const nextBtn   = document.getElementById('nextButton');
    const submitBtn = document.getElementById('submitButton');
    const msg       = document.getElementById('message');

    let cropper, files = [], index = 0, cropped = [];

    // 1) íŒŒì¼ ì„ íƒ
    inputEl.addEventListener('change', e => {
      files = Array.from(e.target.files);
      index = 0;
      cropped = [];
      msg.textContent = '';
      if (files.length > 0) {
        showImage(files[0]);
      }
    });

    // 2) ì´ë¯¸ì§€ í‘œì‹œ + Cropper ì´ˆê¸°í™”
    function showImage(file) {
      cropBtn.disabled = nextBtn.disabled = submitBtn.disabled = true;
      const reader = new FileReader();
      reader.onload = evt => {
        preview.onload = () => {
          if (cropper) cropper.destroy();
          cropper = new Cropper(preview, { viewMode: 1 });
          cropBtn.disabled = nextBtn.disabled = submitBtn.disabled = false;
        };
        preview.src = evt.target.result;
        preview.style.display = 'block';
        controls.style.display = 'block';
      };
      reader.readAsDataURL(file);
    }

    // 3) í˜„ì¬ ì´ë¯¸ì§€ í¬ë¡­ â†’ Blob ì €ì¥
    function cropCurrent() {
      return new Promise((resolve, reject) => {
        if (!cropper) {
          msg.textContent = 'âš ï¸ Cropper ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.';
          return reject();
        }
        cropper.getCroppedCanvas({ width: 512, height: 512 }).toBlob(blob => {
          if (!blob) {
            msg.textContent = 'âš ï¸ í¬ë¡­ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.';
            return reject();
          }
          cropped.push({ blob, name: files[index].name });
          resolve();
        });
      });
    }

    // ë²„íŠ¼ ì´ë²¤íŠ¸
    cropBtn.addEventListener('click', async () => {
      await cropCurrent();
      msg.textContent = `âœ… ${files[index].name} í¬ë¡­ ì™„ë£Œ`;
    });

    nextBtn.addEventListener('click', async () => {
      await cropCurrent();
      // ë‹¤ìŒ íŒŒì¼ì´ ìˆìœ¼ë©´ í‘œì‹œ, ì—†ìœ¼ë©´ nextë§Œ ë¹„í™œì„±
      if (index + 1 < files.length) {
        index++;
        showImage(files[index]);
        msg.textContent = '';
      } else {
        nextBtn.disabled = true;
        msg.textContent = 'âœ… ëª¨ë“  ì´ë¯¸ì§€ í¬ë¡­ ì™„ë£Œ. â€œë¶„ì„ ì œì¶œâ€ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.';
      }
    });

    submitBtn.addEventListener('click', async () => {
      // ë§ˆì§€ë§‰ ì´ë¯¸ì§€ë„ í¬ë¡­
      if (index < files.length) {
        await cropCurrent();
      }
      if (cropped.length === 0) {
        msg.textContent = 'âš ï¸ í¬ë¡­ëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.';
        return;
      }

      // â€” ë™ì  form ìƒì„± & íŒŒì¼ ì²¨ë¶€ â€”
      const dynForm = document.createElement('form');
      dynForm.method = 'POST';
      dynForm.action = '/analyze';
      dynForm.enctype = 'multipart/form-data';

      cropped.forEach(item => {
        const dt = new DataTransfer();
        dt.items.add(new File([item.blob], item.name, { type: 'image/png' }));
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.name = 'cropped_images';
        fileInput.files = dt.files;
        dynForm.appendChild(fileInput);
      });

      document.body.appendChild(dynForm);
      dynForm.submit();
    });
  });
  </script>
</body>
</html>
